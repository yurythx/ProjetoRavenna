services:
  chatwoot-rails:
    image: ${CHATWOOT_IMAGE}
    depends_on:
      postgres_chatwoot:
        condition: service_healthy
      redis_chatwoot:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - MAILER_SENDER_EMAIL=${MAILER_SENDER_EMAIL}
      - SMTP_DOMAIN=${SMTP_DOMAIN}
      - SMTP_ADDRESS=${SMTP_ADDRESS}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_AUTHENTICATION=${SMTP_AUTHENTICATION}
      - SMTP_ENABLE_STARTTLS_AUTO=${SMTP_ENABLE_STARTTLS_AUTO}
      - SMTP_OPENSSL_VERIFY_MODE=${SMTP_OPENSSL_VERIFY_MODE}
      - MAILER_INBOUND_EMAIL_DOMAIN=${MAILER_INBOUND_EMAIL_DOMAIN}
      - RAILS_ENV=${RAILS_ENV}
      - NODE_ENV=${NODE_ENV}
      - INSTALLATION_ENV=${INSTALLATION_ENV}
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - FRONTEND_URL=${FRONTEND_URL}
      - FORCE_SSL=${FORCE_SSL}
      - ENABLE_ACCOUNT_SIGNUP=${ENABLE_ACCOUNT_SIGNUP}
      - USE_INBOX_AVATAR_FOR_BOT=${USE_INBOX_AVATAR_FOR_BOT}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_USERNAME=${POSTGRES_USERNAME}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE}
      - REDIS_URL=${REDIS_URL}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - RAILS_LOG_TO_STDOUT=${RAILS_LOG_TO_STDOUT}
      - LOG_LEVEL=${LOG_LEVEL}
    networks:
      - app_network
    ports:
      - "${CHATWOOT_PORT}:3000"
    volumes:
      - chatwoot_data:/app/storage
    restart: ${RESTART_POLICY:-unless-stopped}
    entrypoint: ["/bin/sh", "-lc"]
    command: ["bundle exec rails db:prepare && bundle exec rails s -p 3000 -b 0.0.0.0"]
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  chatwoot-sidekiq:
    image: ${CHATWOOT_IMAGE}
    depends_on:
      postgres_chatwoot:
        condition: service_healthy
      redis_chatwoot:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - MAILER_SENDER_EMAIL=${MAILER_SENDER_EMAIL}
      - SMTP_DOMAIN=${SMTP_DOMAIN}
      - SMTP_ADDRESS=${SMTP_ADDRESS}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_AUTHENTICATION=${SMTP_AUTHENTICATION}
      - SMTP_ENABLE_STARTTLS_AUTO=${SMTP_ENABLE_STARTTLS_AUTO}
      - SMTP_OPENSSL_VERIFY_MODE=${SMTP_OPENSSL_VERIFY_MODE}
      - MAILER_INBOUND_EMAIL_DOMAIN=${MAILER_INBOUND_EMAIL_DOMAIN}
      - RAILS_ENV=${RAILS_ENV}
      - NODE_ENV=${NODE_ENV}
      - INSTALLATION_ENV=${INSTALLATION_ENV}
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - FRONTEND_URL=${FRONTEND_URL}
      - FORCE_SSL=${FORCE_SSL}
      - ENABLE_ACCOUNT_SIGNUP=${ENABLE_ACCOUNT_SIGNUP}
      - USE_INBOX_AVATAR_FOR_BOT=${USE_INBOX_AVATAR_FOR_BOT}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_USERNAME=${POSTGRES_USERNAME}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE}
      - REDIS_URL=${REDIS_URL}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - RAILS_LOG_TO_STDOUT=${RAILS_LOG_TO_STDOUT}
      - LOG_LEVEL=${LOG_LEVEL}
    networks:
      - app_network
    volumes:
      - chatwoot_data:/app/storage
    restart: ${RESTART_POLICY:-unless-stopped}
    container_name: ${CHATWOOT_SIDEKIQ_CONTAINER}
    command: ["/bin/sh", "-lc", "bundle exec rails db:prepare && bundle exec sidekiq -C config/sidekiq.yml"]
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f sidekiq || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  postgres_chatwoot:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: chatwoot_production
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_chatwoot_data:/var/lib/postgresql/data
    networks:
      - app_network
    restart: always
    container_name: postgres_chatwoot
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d chatwoot_production"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  redis_chatwoot:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis_chatwoot_data:/data
    networks:
      - app_network
    restart: always
    container_name: redis_chatwoot
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping | grep PONG"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  n8n:
    image: n8nio/n8n:1.113.3
    depends_on:
      postgres_n8n:
        condition: service_healthy
      redis_n8n:
        condition: service_healthy
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - tmp_data:/home/n8n/.tmp
    networks:
      - app_network
    restart: always
    env_file:
      - .env
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_HOST: postgres_n8n
      DB_POSTGRESDB_DATABASE: n8n_fila
      DB_POSTGRESDB_USER: postgres
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_HOST: n8n.projetohavoc.shop
      N8N_EDITOR_BASE_URL: https://n8n.projetohavoc.shop/
      N8N_PROTOCOL: https
      NODE_ENV: production
      WEBHOOK_URL: https://n8n.projetohavoc.shop/
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      QUEUE_BULL_REDIS_HOST: redis_n8n
      QUEUE_BULL_REDIS_PORT: 6379
      QUEUE_BULL_REDIS_DB: 0
      QUEUE_BULL_REDIS_PASSWORD: ${REDIS_PASSWORD}
      EXECUTIONS_MODE: regular
      NODE_FUNCTION_ALLOW_EXTERNAL: moment,lodash,moment-with-locales
      EXECUTIONS_DATA_PRUNE: 'true'
      EXECUTIONS_DATA_MAX_AGE: 336
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: 'true'
      N8N_SECURE_COOKIE: "true"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5678/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  postgres_n8n:
    image: postgres:16
    environment:
      POSTGRES_DB: n8n_fila
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_n8n_data:/var/lib/postgresql/data
    networks:
      - app_network
    restart: always
    container_name: postgres_n8n
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d n8n_fila"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  redis_n8n:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis_n8n_data:/data
    networks:
      - app_network
    restart: always
    container_name: redis_n8n
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping | grep PONG"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  evolution_api:
    image: ${EVOLUTION_IMAGE}
    container_name: ${EVOLUTION_CONTAINER}
    depends_on:
      postgres_evolution:
        condition: service_healthy
      redis_evolution:
        condition: service_healthy
    environment:
      - SERVER_URL=${SERVER_URL}
      - DEL_INSTANCE=${DEL_INSTANCE}
      - DEL_TEMP_INSTANCES=${DEL_TEMP_INSTANCES}
      - PROVIDER_ENABLED=${PROVIDER_ENABLED}
      - PROVIDER_HOST=${PROVIDER_HOST}
      - PROVIDER_PORT=${PROVIDER_PORT}
      - PROVIDER_PREFIX=${PROVIDER_PREFIX}
      - DATABASE_ENABLED=${DATABASE_ENABLED}
      - DATABASE_PROVIDER=${DATABASE_PROVIDER}
      - DATABASE_CONNECTION_URI=${DATABASE_CONNECTION_URI}
      - DATABASE_CONNECTION_CLIENT_NAME=${DATABASE_CONNECTION_CLIENT_NAME}
      - RABBITMQ_ENABLED=${RABBITMQ_ENABLED}
      - RABBITMQ_URI=${RABBITMQ_URI}
      - RABBITMQ_EXCHANGE_NAME=${RABBITMQ_EXCHANGE_NAME}
      - RABBITMQ_GLOBAL_ENABLED=${RABBITMQ_GLOBAL_ENABLED}
      - RABBITMQ_EVENTS_APPLICATION_STARTUP=${RABBITMQ_EVENTS_APPLICATION_STARTUP}
      - RABBITMQ_EVENTS_INSTANCE_CREATE=${RABBITMQ_EVENTS_INSTANCE_CREATE}
      - RABBITMQ_EVENTS_INSTANCE_DELETE=${RABBITMQ_EVENTS_INSTANCE_DELETE}
      - RABBITMQ_EVENTS_QRCODE_UPDATED=${RABBITMQ_EVENTS_QRCODE_UPDATED}
      - RABBITMQ_EVENTS_MESSAGES_SET=${RABBITMQ_EVENTS_MESSAGES_SET}
      - RABBITMQ_EVENTS_MESSAGES_UPSERT=${RABBITMQ_EVENTS_MESSAGES_UPSERT}
      - RABBITMQ_EVENTS_MESSAGES_EDITED=${RABBITMQ_EVENTS_MESSAGES_EDITED}
      - RABBITMQ_EVENTS_MESSAGES_UPDATE=${RABBITMQ_EVENTS_MESSAGES_UPDATE}
      - RABBITMQ_EVENTS_MESSAGES_DELETE=${RABBITMQ_EVENTS_MESSAGES_DELETE}
      - RABBITMQ_EVENTS_SEND_MESSAGE=${RABBITMQ_EVENTS_SEND_MESSAGE}
      - RABBITMQ_EVENTS_CONTACTS_SET=${RABBITMQ_EVENTS_CONTACTS_SET}
      - RABBITMQ_EVENTS_CONTACTS_UPSERT=${RABBITMQ_EVENTS_CONTACTS_UPSERT}
      - RABBITMQ_EVENTS_CONTACTS_UPDATE=${RABBITMQ_EVENTS_CONTACTS_UPDATE}
      - RABBITMQ_EVENTS_PRESENCE_UPDATE=${RABBITMQ_EVENTS_PRESENCE_UPDATE}
      - RABBITMQ_EVENTS_CHATS_SET=${RABBITMQ_EVENTS_CHATS_SET}
      - RABBITMQ_EVENTS_CHATS_UPSERT=${RABBITMQ_EVENTS_CHATS_UPSERT}
      - RABBITMQ_EVENTS_CHATS_UPDATE=${RABBITMQ_EVENTS_CHATS_UPDATE}
      - RABBITMQ_EVENTS_CHATS_DELETE=${RABBITMQ_EVENTS_CHATS_DELETE}
      - RABBITMQ_EVENTS_GROUPS_UPSERT=${RABBITMQ_EVENTS_GROUPS_UPSERT}
      - RABBITMQ_EVENTS_GROUP_UPDATE=${RABBITMQ_EVENTS_GROUP_UPDATE}
      - RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE=${RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE}
      - RABBITMQ_EVENTS_CONNECTION_UPDATE=${RABBITMQ_EVENTS_CONNECTION_UPDATE}
      - RABBITMQ_EVENTS_CALL=${RABBITMQ_EVENTS_CALL}
      - RABBITMQ_EVENTS_TYPEBOT_START=${RABBITMQ_EVENTS_TYPEBOT_START}
      - RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS=${RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS}
      - WEBSOCKET_ENABLED=${WEBSOCKET_ENABLED}
      - WEBSOCKET_GLOBAL_EVENTS=${WEBSOCKET_GLOBAL_EVENTS}
      - WA_BUSINESS_TOKEN_WEBHOOK=${WA_BUSINESS_TOKEN_WEBHOOK}
      - WA_BUSINESS_URL=${WA_BUSINESS_URL}
      - WA_BUSINESS_VERSION=${WA_BUSINESS_VERSION}
      - WA_BUSINESS_LANGUAGE=${WA_BUSINESS_LANGUAGE}
      - WEBHOOK_GLOBAL_URL=${WEBHOOK_GLOBAL_URL}
      - WEBHOOK_GLOBAL_ENABLED=${WEBHOOK_GLOBAL_ENABLED}
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=${WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS}
      - WEBHOOK_EVENTS_APPLICATION_STARTUP=${WEBHOOK_EVENTS_APPLICATION_STARTUP}
      - WEBHOOK_EVENTS_QRCODE_UPDATED=${WEBHOOK_EVENTS_QRCODE_UPDATED}
      - WEBHOOK_EVENTS_MESSAGES_SET=${WEBHOOK_EVENTS_MESSAGES_SET}
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=${WEBHOOK_EVENTS_MESSAGES_UPSERT}
      - WEBHOOK_EVENTS_MESSAGES_EDITED=${WEBHOOK_EVENTS_MESSAGES_EDITED}
      - WEBHOOK_EVENTS_MESSAGES_UPDATE=${WEBHOOK_EVENTS_MESSAGES_UPDATE}
      - WEBHOOK_EVENTS_MESSAGES_DELETE=${WEBHOOK_EVENTS_MESSAGES_DELETE}
      - WEBHOOK_EVENTS_SEND_MESSAGE=${WEBHOOK_EVENTS_SEND_MESSAGE}
      - WEBHOOK_EVENTS_CONTACTS_SET=${WEBHOOK_EVENTS_CONTACTS_SET}
      - WEBHOOK_EVENTS_CONTACTS_UPSERT=${WEBHOOK_EVENTS_CONTACTS_UPSERT}
      - WEBHOOK_EVENTS_CONTACTS_UPDATE=${WEBHOOK_EVENTS_CONTACTS_UPDATE}
      - WEBHOOK_EVENTS_PRESENCE_UPDATE=${WEBHOOK_EVENTS_PRESENCE_UPDATE}
      - WEBHOOK_EVENTS_CHATS_SET=${WEBHOOK_EVENTS_CHATS_SET}
      - WEBHOOK_EVENTS_CHATS_UPSERT=${WEBHOOK_EVENTS_CHATS_UPSERT}
      - WEBHOOK_EVENTS_CHATS_UPDATE=${WEBHOOK_EVENTS_CHATS_UPDATE}
      - WEBHOOK_EVENTS_CHATS_DELETE=${WEBHOOK_EVENTS_CHATS_DELETE}
      - WEBHOOK_EVENTS_GROUPS_UPSERT=${WEBHOOK_EVENTS_GROUPS_UPSERT}
      - WEBHOOK_EVENTS_GROUPS_UPDATE=${WEBHOOK_EVENTS_GROUPS_UPDATE}
      - WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE=${WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE}
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=${WEBHOOK_EVENTS_CONNECTION_UPDATE}
      - WEBHOOK_EVENTS_LABELS_EDIT=${WEBHOOK_EVENTS_LABELS_EDIT}
      - WEBHOOK_EVENTS_LABELS_ASSOCIATION=${WEBHOOK_EVENTS_LABELS_ASSOCIATION}
      - WEBHOOK_EVENTS_CALL=${WEBHOOK_EVENTS_CALL}
      - WEBHOOK_EVENTS_TYPEBOT_START=${WEBHOOK_EVENTS_TYPEBOT_START}
      - WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS=${WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS}
      - AUTHENTICATION_API_KEY=${AUTHENTICATION_API_KEY}
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=${AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES}
      - LANGUAGE=${LANGUAGE}
      - TELEMETRY=${TELEMETRY}
      - CONFIG_SESSION_PHONE_VERSION=${CONFIG_SESSION_PHONE_VERSION}
      - CONFIG_SESSION_PHONE_CLIENT=${CONFIG_SESSION_PHONE_CLIENT}
      - CONFIG_SESSION_PHONE_NAME=${CONFIG_SESSION_PHONE_NAME}
      - QRCODE_LIMIT=${QRCODE_LIMIT}
      - TYPEBOT_ENABLED=${TYPEBOT_ENABLED}
      - TYPEBOT_API_VERSION=${TYPEBOT_API_VERSION}
      - CHATWOOT_ENABLED=${CHATWOOT_ENABLED}
      - CHATWOOT_MESSAGE_READ=${CHATWOOT_MESSAGE_READ}
      - CHATWOOT_IMPORT_DATABASE_CONNECTION_URI=${CHATWOOT_IMPORT_DATABASE_CONNECTION_URI}
      - CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE=${CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE}
      - CACHE_REDIS_ENABLED=${CACHE_REDIS_ENABLED}
      - CACHE_REDIS_URI=${CACHE_REDIS_URI}
      - CACHE_REDIS_PREFIX_KEY=${CACHE_REDIS_PREFIX_KEY}
      - CACHE_REDIS_SAVE_INSTANCES=${CACHE_REDIS_SAVE_INSTANCES}
      - CACHE_LOCAL_ENABLED=${CACHE_LOCAL_ENABLED}
    networks:
      - app_network
    ports:
      - "${EVOLUTION_PORT}:8080"
    volumes:
      - evolution_data:/evolution/instances
    restart: ${RESTART_POLICY}
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/manager/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  postgres_evolution:
    image: postgres:16
    environment:
      POSTGRES_DB: evolution_production
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_evolution_data:/var/lib/postgresql/data
    networks:
      - app_network
    restart: always
    container_name: postgres_evolution
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d evolution_production"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  redis_evolution:
    image: redis:7-alpine
    volumes:
      - redis_evolution_data:/data
    networks:
      - app_network
    restart: always
    container_name: redis_evolution
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping | grep PONG"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare_tunnel
    networks:
      - app_network
    restart: ${RESTART_POLICY}
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}

  portainer:
    image: portainer/portainer-ce:latest
    container_name: ravenna_portainer
    restart: unless-stopped
    ports:
      - "9002:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - app_network
    environment:
      - PUID=1000
      - PGID=1000
    labels:
      - "traefik.enable=false"
      - "com.docker.compose.project=ravenna"

  backup-ravenna:
    image: alpine:latest
    container_name: backup-ravenna
    restart: unless-stopped
    environment:
      - TZ=America/Sao_Paulo
      - BACKUP_INTERVAL=86400
      - BACKUP_RETENTION=30
      - PROJECT_NAME=ravenna
    volumes:
      - postgres_chatwoot_data:/backup/source/postgres_chatwoot_data:ro
      - postgres_n8n_data:/backup/source/postgres_n8n_data:ro
      - postgres_evolution_data:/backup/source/postgres_evolution_data:ro
      - chatwoot_data:/backup/source/chatwoot_data:ro
      - n8n_data:/backup/source/n8n_data:ro
      - evolution_data:/backup/source/evolution_data:ro
      - portainer_data:/backup/source/portainer_data:ro
      - ./backup/backup_destination:/backup/destination
    command: >
      sh -c "apk add --no-cache tar gzip coreutils findutils && mkdir -p /backup/destination && while true; do BACKUP_DATE=$(date +%Y%m%d_%H%M%S) && BACKUP_FILE=\"ravenna_backup_$${BACKUP_DATE}.tar.gz\" && BACKUP_PATH=\"/backup/destination/$${BACKUP_FILE}\" && cd /backup/source && VOLUMES_TO_BACKUP=\"\" && for vol in postgres_chatwoot_data postgres_n8n_data postgres_evolution_data chatwoot_data n8n_data evolution_data portainer_data; do if [ -d \"$${vol}\" ] && [ \"$(ls -A $${vol} 2>/dev/null)\" ]; then VOLUMES_TO_BACKUP=\"$${VOLUMES_TO_BACKUP} $${vol}/\"; fi; done && if [ -n \"$${VOLUMES_TO_BACKUP}\" ]; then tar -czf \"$${BACKUP_PATH}\" $${VOLUMES_TO_BACKUP} 2>/dev/null; else echo \"Estrutura de backup\" > /tmp/backup_placeholder.txt && tar -czf \"$${BACKUP_PATH}\" -C /tmp backup_placeholder.txt 2>/dev/null; fi && if [ -f \"$${BACKUP_PATH}\" ]; then if tar -tzf \"$${BACKUP_PATH}\" >/dev/null 2>&1; then find /backup/destination -name \"ravenna_backup_*.tar.gz\" -type f -mtime +$${BACKUP_RETENTION} -delete; fi; fi; sleep $${BACKUP_INTERVAL}; done"
    healthcheck:
      test: ["CMD", "sh", "-c", "find /backup/destination -name 'ravenna_backup_*.tar.gz' -mtime -2 | grep -q ."]
      interval: 1h
      timeout: 30s
      retries: 3
      start_period: 5m
    networks:
      - app_network
    labels:
      - "com.projeto.ravenna.backup=true"
      - "com.projeto.ravenna.service=backup"
      - "com.projeto.ravenna.version=1.0"

volumes:
  chatwoot_data:
  postgres_chatwoot_data:
  redis_chatwoot_data:
  n8n_data:
  tmp_data:
  postgres_n8n_data:
  redis_n8n_data:
  evolution_data:
  postgres_evolution_data:
  redis_evolution_data:
  portainer_data:

networks:
  app_network:
    driver: bridge
